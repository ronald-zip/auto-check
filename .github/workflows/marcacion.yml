name: Marcación Automática Domingo

on:
  schedule:
    # Domingo a las horas de Perú (UTC+5)
    - cron: "0 13 * * 1-5"   # 8:00 AM Perú
    - cron: "0 18 * * 1-5"   # 1:00 PM Perú
    - cron: "0 19 * * 1-5"   # 2:00 PM Perú
    - cron: "1 0 * * 2-6"    # 7:01 PM Perú (domingo en Perú, pero lunes UTC)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  send-post:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Configurar hora de Perú
        run: sudo timedatectl set-timezone America/Lima

      - name: Ejecutar marcación y guardar log
        run: |
          mkdir -p logs
          touch logs/log.txt
          
          # Obtener hora actual de Perú
          FECHA=$(date "+%Y-%m-%d %H:%M:%S")

          # Determinar tipo de marcación según hora actual
          HORA=$(date "+%H:%M")
          if [ "$HORA" = "08:00" ]; then TIPO="ME"; fi
          if [ "$HORA" = "13:00" ]; then TIPO="IR"; fi
          if [ "$HORA" = "14:00" ]; then TIPO="FR"; fi
          if [ "$HORA" = "19:01" ]; then TIPO="MS"; fi

          # JSON a enviar
          JSON=$(jq -n \
            --arg compania "02" \
            --arg correo "rsinche@continental.edu.pe" \
            --arg fecha_hora "$FECHA" \
            --arg tipo_marcacion "$TIPO" \
            '{compania: $compania, correo: $correo, fecha_hora: $fecha_hora, tipo_marcacion: $tipo_marcacion}'
          )

          # Enviar petición y guardar respuesta
          RESPUESTA=$(curl -s -X POST "https://webapimarcacion.continental.edu.pe/api/marcacion/registrar" \
            -H "Content-Type: application/json" \
            -H "apikey: 6bd4da79-7408-44e5-93fd-5da461a97873" \
            -d "$JSON")

          # Guardar en log
          echo "Fecha de envío: $FECHA" >> logs/log.txt
          echo "JSON enviado: $JSON" >> logs/log.txt
          echo "Respuesta del servidor: $RESPUESTA" >> logs/log.txt
          echo "----------------------------------------" >> logs/log.txt

      - name: Commit y push del log
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add logs/log.txt
          git commit -m "Actualizar log automático"
          git push
